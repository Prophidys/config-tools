# Virtualization


The virtualization directory contains the tools which aims to standardize the way
we test an architecture in a virtual environment.

## Pre-requesites

```sh
$ pip install -r requirements.txt
```

### Collector

```sh
$ ./collector.py --help
usage: collector.py [-h] [--config-dir CONFIG_DIR] [--output-dir OUTPUT_DIR]
                    --sps-version SPS_VERSION

Generate virtual infrastructure description.

optional arguments:
  -h, --help            show this help message and exit
  --config-dir CONFIG_DIR
                        The config directory absolute path
  --output-dir OUTPUT_DIR
                        The output directory of the virtual configuration.
  --sps-version SPS_VERSION
                        The SpinalStack version.
```

### Virtualizor

```sh
usage: virtualizor.py [-h] [--replace] [--pub-key-file PUB_KEY_FILE]
                      [--prefix PREFIX] [--public_network PUBLIC_NETWORK]
                      input_file target_host

Deploy a virtual infrastructure.

positional arguments:
  input_file            the YAML input file, as generated by collector.py.
  target_host           the name of the libvirt server. The local user must be
                        able to connect to the root account with no password
                        authentification.

optional arguments:
  -h, --help            show this help message and exit
  --replace             existing conflicting resources will be remove
                        recreated.
  --pub-key-file PUB_KEY_FILE
                        the path to the SSH public key file that must be
                        injected in the install-server root and jenkins
                        account
  --prefix PREFIX       optional prefix to put in the machine and network to
                        avoid conflict with resources create by another
                        virtualizor instance. Thanks to this parameter, the
                        user can run as virtualizor as needed on the same
                        machine.
  --public_network PUBLIC_NETWORK
                        allow the user to pass the name of a libvirt NATed
                        network that will be used as a public network for the
                        install-server. This public network will by attached
                        to eth1 interface and IP address is associated using
                        the DHCP.
```

### Example

```sh
$ ./config-tools/download.sh I.1.3.0 deployment-3nodes-D7.yml version=D7-I.1.3.0
```

It generates a directory 'top/' in the current directory.

```sh
$ ./collector.py --config-dir ./top/etc --sps-version D7-I.1.3.0
Virtual platform generated successfully at 'virt_platform.yml' !
```

It will generate a file 'virt_platform.yml' which describe the corresponding virtual
platform. You may take a look at a sample in the virtualization directory.

```sh
$ ./virtualizor.py virt_platform.yml my-hypervisor-node --replace --pub-key-file ~/.ssh/boa.pub
```
